<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Etheroom</title>
  <script src="../node_modules/web3/dist/web3.min.js"></script>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <main class="container">
    <header class="header-section">
      <div class="header-top">
        <div class="header-content">
          <div class="header-inner">
            <img class="etheroom-logo" src="./assets/Group 4.png" alt="Etheroom brand logo" />

            <nav class="nav-bar">
              <a href="#" class="nav-item">Home</a>
              <a href="#" class="nav-item">All Hotels</a>
              <a href="#" class="nav-item">Explore Cities</a>
              <a href="#" class="nav-item">About Us</a>
              <a href="#" class="nav-item">FAQ</a>
            </nav>
            <div class="header-right-actions">
              <div tabindex="0" role="button" class="signin-btn">Sign In</div>
              <div tabindex="0" role="button" class="signup-btn">Sign Up</div>
            </div>
          </div>
        </div>
      </div>
    </header>
    <section class="main-section">
      <div class="main-inner">
        <div class="details-section">
          <div class="details-content">
            <div class="details-header">Bedroom in London City</div>
            <div class="details-subheader">Tooley Street, Sector 70, United Kingdom</div>
            <div class="details-images">
              <div class="image-column-vertical">
                <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/387c546cf5b06ccc6ab39959e3921aefd10a4dee29a1c4e3c67ac8bfde5f2347?apiKey=c5bd63d219db4e64b9764c41103b2d6b&" class="vertical-img" alt="Bedroom Image 1" />
                <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/4b9e0e8d5671b0121d0090a6248abd7f06ba95f4419ffeddc149c73f920d3589?apiKey=c5bd63d219db4e64b9764c41103b2d6b&" class="vertical-img" alt="Bedroom Image 2" />
                <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/6602c1a67cffb4b9d5915f6ea81e12e047e59bb04908a862ebfbd36bda760b82?apiKey=c5bd63d219db4e64b9764c41103b2d6b&" class="vertical-img" alt="Bedroom Image 3" />
                <div class="overlay-img-container">
                  <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/d0edfb1a6f3901b24f51a25a84cb57f2fcb2aec272a91e0e66f4125884a65ccb?apiKey=c5bd63d219db4e64b9764c41103b2d6b&" class="vertical-img" alt="Additional Bedroom Image" />
                  <div class="overlay-text">+2</div>
                </div>
              </div>
              <div class="image-column-horizontal">
                <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/1cebdd4f8e778b3d373e5cda3dd5b04477fbfee3b31acbf063508e82a7febf12?apiKey=c5bd63d219db4e64b9764c41103b2d6b&" class="horizontal-img" alt="Main Bedroom Image" />
              </div>
            </div>
            <div class="feature-segment">
              <div class="details-icons">
                <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/b4d0263c87749065617cba54b52250d74ac0d570676b88a2b8c189e7e3b3766b?apiKey=c5bd63d219db4e64b9764c41103b2d6b&" class="details-icon" alt="Room Info Icon" />
                <div class="details-title">
                  Room Information:
                </div>
              </div>
              <div class="multi-column">
                <div class="column-left">
                  <div class="feature-list">
                    <ul>
                      <li>Flat-screen TV</li>
                      <li>Work Desk</li>
                      <li>Iron and ironing board</li>
                      <li>Free toilets</li>
                    </ul>
                  </div>
                </div>
                <div class="column-right">
                  <div class="feature-list">
                    <ul>
                      <li>Hairdryer</li>
                      <li>Free unlimited Wi-Fi</li>
                      <li>Coffee & Tea Maker</li>
                      <li>Telephone</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="booking-section">
          <div class="tabs-container">
            <div tabindex="0" role="button" class="tab-title">Booking</div>
          </div>
          <div class="currency-price">
            <img src="./assets/brand_ethereum_icon_158920 1.png" class="segment-image" alt="Booking Image" />
            <div class="price">0,053 ETH/night</div>
          </div>
          <div class="currency-converter">
            <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/37fda18346278d8b756c8db18a54ada2bc588903e01c0bb3b9457dc95c40ec43?apiKey=c5bd63d219db4e64b9764c41103b2d6b&" class="currency-icon" alt="Currency Icon" />
            <div class="currency-text">Currency converter</div>
          </div>
          <div class="booking-info">
            <div class="booking-details">
              <div class="date-range">
                <label for="checkin_date" class="input-date">Check In</label>
                <div class="input-placeholder">Arrive Date</div>
              </div>
              <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/a79e335954cd14b9841d15ee0eb2f8b0147ebfe20db420462bb796f689a2302d?apiKey=c5bd63d219db4e64b9764c41103b2d6b&" class="date-picker-icon" alt="Date Picker Icon" />
            </div>
            <div class="booking-details">
              <div class="date-range">
                <label for="checkout_date" class="input-date">Check Out</label>
                <div class="input-placeholder">Leave Date</div>
              </div>
              <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/a79e335954cd14b9841d15ee0eb2f8b0147ebfe20db420462bb796f689a2302d?apiKey=c5bd63d219db4e64b9764c41103b2d6b&" class="date-picker-icon" alt="Date Picker Icon" />
            </div>
          </div>
          <div class="room-info">
            <div class="room-details">
              <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/b4d0263c87749065617cba54b52250d74ac0d570676b88a2b8c189e7e3b3766b?apiKey=c5bd63d219db4e64b9764c41103b2d6b&" class="details-icon" alt="Room Type Icon" />
              <div class="details-title">Room Types</div>
            </div>
            <div class="guests-info">
              <div class="guest-title">Number of Guests</div>
              <div class="guest-range">1-4</div>
            </div>
          </div>
          <div class="payment-section">
            <div class="payment-details">
              <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/a88431bc1400ae5054577036f317a326ee820b196f7f10c61d8a24c3ed80295e?apiKey=c5bd63d219db4e64b9764c41103b2d6b&" class="currency-icon" alt="Payment Icon" />
              <div class="payment-text">Payment</div>
            </div>
            <div id="conectar">
                <div tabindex="0" role="button" class="wallet-btn" id="btnConectar" style="display: none">
                <div class="wallet-label">CONNECT WALLET</div>
                <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/1d8dd0382c16396155cf11001f63ba813906cc645d629d201d185980b41cda00?apiKey=c5bd63d219db4e64b9764c41103b2d6b&" class="wallet-icon" alt="Wallet Icon" />
                </div>
            </div>
          </div>
          <div class="help-btn">
            <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/37fda18346278d8b756c8db18a54ada2bc588903e01c0bb3b9457dc95c40ec43?apiKey=c5bd63d219db4e64b9764c41103b2d6b&" class="help-icon" alt="Help Icon" />
            <div class="help-text">Need Help?</div>
          </div>
          <div>
            <button id="reservar" style="display: none" class="room-reservation">Reservar quarto</button>
        </div>
        <div>
          <div class="id-group">
            <input id="bookingId" type="text" placeholder="ID da reserva" style="display: none; margin-bottom: 16px;" class="id-field"/>
            <label for="name" class="id-label">ID da reserva</label>
          </div>
            <button id="obterReserva" style="display: none" class="get-reservation">Obter Reserva</button>
        </div>
        <div id="idReserva">&nbsp;</div>
        <div id="detalhesReserva">&nbsp;</div>
        </div>
      </div>
    </section>
  </main>

  <script>
    var provider = window.ethereum;
    var abi = [ { "inputs": [], "stateMutability": "nonpayable", "type": "constructor" }, { "anonymous": false, "inputs": [ { "indexed": true, "internalType": "uint256", "name": "bookingId", "type": "uint256" }, { "indexed": true, "internalType": "address", "name": "guest", "type": "address" } ], "name": "BookingCancelled", "type": "event" }, { "anonymous": false, "inputs": [ { "indexed": true, "internalType": "uint256", "name": "bookingId", "type": "uint256" }, { "indexed": false, "internalType": "address", "name": "bookingContract", "type": "address" }, { "indexed": true, "internalType": "address", "name": "guest", "type": "address" }, { "indexed": false, "internalType": "string", "name": "hotel", "type": "string" }, { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" } ], "name": "BookingCreated", "type": "event" }, { "inputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "name": "bookingContracts", "outputs": [ { "internalType": "address", "name": "", "type": "address" } ], "stateMutability": "view", "type": "function", "constant": true }, { "inputs": [], "name": "bookingCount", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function", "constant": true }, { "inputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "name": "bookings", "outputs": [ { "internalType": "address", "name": "bookingContract", "type": "address" }, { "internalType": "address", "name": "guest", "type": "address" }, { "internalType": "string", "name": "hotel", "type": "string" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }, { "internalType": "bool", "name": "isActive", "type": "bool" } ], "stateMutability": "view", "type": "function", "constant": true }, { "inputs": [], "name": "owner", "outputs": [ { "internalType": "address", "name": "", "type": "address" } ], "stateMutability": "view", "type": "function", "constant": true }, { "inputs": [ { "internalType": "string", "name": "_hotel", "type": "string" }, { "internalType": "uint256", "name": "_amount", "type": "uint256" }, { "internalType": "uint256", "name": "_checkInDate", "type": "uint256" }, { "internalType": "uint256", "name": "_checkOutDate", "type": "uint256" } ], "name": "createBooking", "outputs": [], "stateMutability": "payable", "type": "function", "payable": true }, { "inputs": [ { "internalType": "uint256", "name": "_bookingId", "type": "uint256" } ], "name": "cancelBooking", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [ { "internalType": "uint256", "name": "_bookingId", "type": "uint256" } ], "name": "getBooking", "outputs": [ { "components": [ { "internalType": "address", "name": "bookingContract", "type": "address" }, { "internalType": "address", "name": "guest", "type": "address" }, { "internalType": "string", "name": "hotel", "type": "string" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }, { "internalType": "bool", "name": "isActive", "type": "bool" } ], "internalType": "struct HotelBookingManager.BookingInfo", "name": "", "type": "tuple" } ], "stateMutability": "view", "type": "function", "constant": true }, { "inputs": [], "name": "getBookingContracts", "outputs": [ { "internalType": "address[]", "name": "", "type": "address[]" } ], "stateMutability": "view", "type": "function", "constant": true } ];
    var endereco = '0xC5Dde23F21164BbD61E4B59c756cd4c64A487d87'; // endereço do HotelBookingManager
    var conta = "";

    async function run() {
        if (!provider) {
            document.getElementById("conectar").innerHTML = "Por favor, instale o Metamask";
        } else {
            let contas = await provider.request({ method: 'eth_accounts' });

            if (contas.length == 0) {
                document.getElementById("btnConectar").style.display = 'flex';
                document.getElementById("btnConectar").addEventListener('click', conectarMM);
            } else {
                document.getElementById("conectar").innerHTML = contas[0];
                conta = contas[0];
                document.getElementById("reservar").style.display = 'block';
                document.getElementById("bookingId").style.display = 'block';
                document.getElementById("obterReserva").style.display = 'block';
                document.getElementById("reservar").addEventListener('click', () => reservarQuarto('Viridian Apartments, Tooley Street, Sector 70', 0.21, 4, 12));
                document.getElementById("obterReserva").addEventListener('click', obterReserva);
            }
        }
    }

    async function conectarMM() {
        let contas = await provider.request({ method: 'eth_requestAccounts' });
        document.getElementById("conectar").innerHTML = contas[0];
        conta = contas[0];
    }

    async function reservarQuarto(nomeHotel, valor, checkIn, checkOut) {
        let web3 = new Web3(provider);
        let contract = new web3.eth.Contract(abi, endereco);

        const valorWei = web3.utils.toWei(valor.toString(), 'ether');

        try {
            let receipt = await contract.methods.createBooking(nomeHotel, valorWei, checkIn, checkOut).send({
                from: conta,
                value: valorWei
            });

            // Extrair o ID da reserva do evento "BookingCreated"
            let bookingId = receipt.events.BookingCreated.returnValues.bookingId;
            console.log(`ID da Reserva: ${bookingId}`);
            document.getElementById("idReserva").innerHTML = `ID da Reserva: ${bookingId}`;

        } catch (e) {
            console.log("Algo deu errado", e);
        }
    }

    async function obterReserva() {
        let web3 = new Web3(provider);
        let contract = new web3.eth.Contract(abi, endereco);

        let bookingId = document.getElementById("bookingId").value;

        try {
            let booking = await contract.methods.getBooking(bookingId).call();
            console.log(booking);
            exibirDetalhesReserva(booking);
        } catch (e) {
            console.log("Algo deu errado", e);
        }
    }

    function exibirDetalhesReserva(booking) {

        let web3 = new Web3(provider);
        let valorEther = web3.utils.fromWei(booking.amount, 'ether');

        document.getElementById("detalhesReserva").innerHTML = `
            Contrato de Reserva: ${booking.bookingContract}<br />
            Endereço da conta do hóspede: ${booking.guest}<br />
            Hotel: ${booking.hotel}<br />
            Valor em wei: ${booking.amount} wei<br />
            Valor em ether: ${valorEther} ETH<br />
            Ativo: ${booking.isActive}
        `;
    }

    ethereum.on('chainChanged', () => (window.location.reload()));
    ethereum.on('accountsChanged', () => {alert('A conta foi alterada!'), (window.location.reload())});

    run();

</script>

</body>
</html>